/**
 * @file loadHSP.c
 * @author Ihsane E.
 * @brief
 * @version 0.1
 * @date 2022-10-12
 *
 * @copyright Copyright (c) 2022
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "global.h"
#include "macros.h"
#include "readargs.h"
#include "types.h"
#include <ctype.h>
#include <stdbool.h>
#define NETRA 0

extern int filter(char *seqhsp, char *seq);
extern SimPrf *handlegaps(SimPrf *simprf);

double *loadHSP(SeqHSP *seqres, FILE *file, char *line, int length, char *conserved, double *maxprofile, char type){
	/*************************************************************************************************************************************************/
    /************************************************************Déclaration des variables************************************************************/
    /************************************************************************************************************************************************/
    double maxp, p, facteur, fctr;
    double *profil, *ptr, *simptr;
    SimPrf *simprf;
    char *outtext = NULL, *ptrstr, *begline, *queryseq, *seq, *seqhsp, *startline;
    int endofdbseq = 0, ok = 0, okhsp = 0, gapped, taux, naas, begin, end, debut, dline, n;
    int debdb, enddb, begdb, dline2, dline1;
    int identique;
    /************************************************************************************************************************************************/
    /************************************************************Initialisation de maxp**************************************************************/
    /************************************************************************************************************************************************/
    maxp = getMaxP(maxp, type);
    /************************************************************************************************************************************************/
    /************************************************************Initialisation du profil************************************************************/
    /************************************************************************************************************************************************/
    profil = (double *)malloc(sizeof(double) * length);

    for (int i = 0; i < length; i++)
    {
        ptr = (double *)(profil + i); // typecasting double adresse de profil+i
        *ptr = 0;                     // valeur de p de base mais changer en 0
    }
    /************************************************************************************************************************************************/
    /************************************************************Initialisation de seqres************************************************************/
    /*******************************************************************et simprf********************************************************************/
    /************************************************************************************************************************************************/
    seqres->sc = 0;
    seqres->nmatch = 0;
    seqres->type = type;
    seqres->risedup = ' ';
    seqres->sim = (SimPrf *)malloc(sizeof(SimPrf));
    simprf = seqres->sim;
    simprf->text = NULL;
    simprf->score = 2;
    simprf->maxscore = 0;
    simprf->nmatch = 0;
    seqres->p = 1;
    seqres->prob = maxp;
    /************************************************************************************************************************************************/
    /*****************************************************Récupération de la ligne*******************************************************************/
    /******************************************************où on se trouve (1rst line)***************************************************************/
    /************************************************************************************************************************************************/
    outtext = getOuttext(line, outtext);
    /************************************************************************************************************************************************/
    /******************************************************Condition vérifiant la line***************************************************************/
    /************************************************************************************************************************************************/
    verifLine(line);
    /************************************************************************************************************************************************/
    /******************************************************Récupération de desc**********************************************************************/
    /************************************************************************************************************************************************/
    seqres->desc = getDesc(line, seqres);
    /************************************************************************************************************************************************/
    /******************************************************Récupération de name**********************************************************************/
    /************************************************************************************************************************************************/
    seqres->name = getName(line, ptrstr, seqres);
    /************************************************************************************************************************************************/
    /******************************************************Récupération de access********************************************************************/
    /************************************************************************************************************************************************/
    seqres->access = getAccess(line, ptrstr, seqres);

    fgets(line, 256, file);

    begline = line;
    if (*begline == ' ')
    {
        begline++;
    }
    /************************************************************************************************************************************************/
    /*******************************************************Mise à jour de l'outtext*****************************************************************/
    /*******************************************************(de > jusqu'à la longueur)***************************************************************/
    /************************************************************************************************************************************************/
    seqres->outtext = firstScoreRecovery(line, outtext, begline, file);
    /*************************************************************************************************************************************************/
    /********************************************************On est positionné à la ligne ************************************************************/
    /*******************************************************commençant par score et on cherche********************************************************/
    /****************************************************************la e-value***********************************************************************/
    /*************************************************************************************************************************************************/
    p = eValueRecovery(line, ptrstr, p);

    seqres->prob = p;
    simprf->p = p;
    /*************************************************************************************************************************************************/
    /*******************************************************Condition fixant la e-value***************************************************************/
    /*****************************************************************à 1*****************************************************************************/
    /************************************************************************************************************************************************/
    fixeValue(p, maxp);
    /************************************************************************************************************************************************/
    /*********************************************************Formule de calculs*********************************************************************/
    /************************************************************************************************************************************************/
    facteur = (1.0) * p;
    fctr = 1;
    /************************************************************************************************************************************************/
    /*************************************************Récupération de la ligne de score**************************************************************/
    /************************************************************************************************************************************************/
    simprf->text = getText(line, simprf);
    /************************************************************************************************************************************************/
    /**************************************************Nous sommes à la ligne commencant*************************************************************/
    /*********************************************************par Identities*************************************************************************/
    /************************************************************************************************************************************************/
    fgets(line, 256, file);
    /************************************************************************************************************************************************/
    /**************************************************On parcourt le résultat de l'analyse***********************************************************/
    /************************************************************************************************************************************************/
	
	return profil;
}

double getMaxP(double maxp, char type)
{
    if (getargdouble("-maxp", &maxp) == NULL)
    {
        maxp = DEFMAXP;
        if (type == 'n')
        {
            if (getargdouble("-nmaxp", &maxp) == NULL)
                maxp = DEFMAXP;
        }
    }
    return maxp;
}

void verifLine(char *line)
{
    if (line[0] == '>')
    {
        memmove(line, &line[1], strlen(line));
    }
    // taille de la target (non de la séquence mais de l'identification)
    if (strlen(line) <= 90)
    {
        for (int i = strlen(line) - 1; i < 90; i++)
        {
            line[i] = ' ';
        }
    }

    line[90] = '\0';
}

char *getOuttext(char *line, char *outtext)
{
    outtext = (char *)malloc(strlen(line) + 1);
    strcpy(outtext, line); // strcpy
    return outtext;
}

char *getDesc(char *line, SeqHSP *seqres)
{
    seqres->desc = (char *)malloc(strlen(line) + 1);
    strcpy(seqres->desc, line);
    return seqres->desc;
}

char *getName(char *line, char *ptrstr, SeqHSP *seqres)
{
    ptrstr = strtok(line, " ");
    seqres->name = (char *)malloc(strlen(ptrstr) + 1);
    strcpy(seqres->name, ptrstr);

    ptrstr = strchr(seqres->name, ':');
    if (ptrstr != NULL)
    {
        *ptrstr = '|';
    }
    return seqres->name;
}

char *getAccess(char *line, char *ptrstr, SeqHSP *seqres)
{
    ptrstr = strtok(NULL, " ");
    if (ptrstr != NULL)
    {
        seqres->access = (char *)malloc(strlen(ptrstr) + 1);
        strcpy(seqres->access, ptrstr);
    }
    else
    {
        seqres->access = (char *)malloc(strlen(seqres->name) + 1);
        strcpy(seqres->access, seqres->name);
    }
    return seqres->access;
}

char *firstScoreRecovery(char *line, char *outtext, char *begline, FILE *file)
{
    while (strncmp(begline, "Score", 5) != 0)
    {
        outtext = (char *)realloc(outtext, strlen(outtext) + strlen(line) + 1);
        strcat(outtext, line);
        // on va à la ligne suivante
        fgets(line, 256, file);
        begline = line;

        if (*begline == ' ')
        {
            begline++;
        }
    }
    // on met à jour outtext
    return outtext;
}

double eValueRecovery(char *line, char *ptrstr, double p)
{
    ptrstr = (char *)(strstr(line, "e-"));
    if (ptrstr != NULL)
    {
        ptrstr = (char *)(ptrstr + 1);
        *ptrstr = 1;
    }
    // ici on va récupérer la e-value qui va correspondre à p.
    sscanf((char *)(strrchr(line, '=') + 1), "%lf", &p);
    return p;
}

void fixeValue(double p, double maxp)
{
    if ((p >= maxp) || (p > 1))
    {
        p = 1;
    }
}

char *getText(char *line, SimPrf *simprf)
{
    simprf->text = (char *)malloc(strlen(line) + 1);
    strcpy(simprf->text, line);
    return simprf->text;
}